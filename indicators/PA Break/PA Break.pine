//@version=6
// ─────────────────────────────────────────────────────────────────────────────
// Indicator : PA Break
// ID        : pa_break
// Version   : v0.4.0
// Author    : MTS
// Purpose   : Detect confirmed price action breakouts using swing structure
//             (HH/LL) with swing confirmation. Entry = strongest level in
//             the swing group before the break.
// Notes     : Works on all timeframes. Non-repainting (uses confirmed pivots).
//             Break = HH/LL + optional strength filter + swing confirmation.
// ─────────────────────────────────────────────────────────────────────────────
indicator(
     title      = "PA Break [pa_break] v0.4.0",
     shorttitle = "PA Break v0.4.0",
     overlay    = true,
     max_labels_count = 500,
     max_lines_count  = 500,
     max_boxes_count  = 500
)

// ============================================================================
// A) INPUTS
// ============================================================================
string GRP_CORE  = "Core"
string GRP_STYLE = "Style"

pivotLen   = input.int(5,   "Pivot Lookback", minval = 2, maxval = 50, group = GRP_CORE,
             tooltip = "Number of bars left/right to confirm a Swing High/Low.")
breakMult  = input.float(0, "Break Strength (x Swing Range)", minval = 0, step = 0.25, group = GRP_CORE,
             tooltip = "Break distance must be >= breakMult x previous swing range. 0 = filter OFF.")

// Style
showSwings     = input.bool(false, "Show Swing Points",     group = GRP_STYLE)
showBreakLabel = input.bool(true,  "Show Break Labels",     group = GRP_STYLE)
showBreakLine  = input.bool(true,  "Show Break Lines",      group = GRP_STYLE)

colBreakUp   = input.color(color.new(color.green, 0),  "Break UP Label",     group = GRP_STYLE)
colBreakDown = input.color(color.new(color.red, 0),    "Break DOWN Label",   group = GRP_STYLE)
colEntryBuy  = input.color(color.new(color.blue, 0),   "Entry Buy Color",    group = GRP_STYLE)
colEntrySell = input.color(color.new(#ff69b4, 0),      "Entry Sell Color",   group = GRP_STYLE)
colSL        = input.color(color.new(color.yellow, 0), "SL Color",           group = GRP_STYLE)
colSwingHigh = input.color(color.new(color.orange, 40), "Swing High Color",  group = GRP_STYLE)
colSwingLow  = input.color(color.new(color.blue, 40),   "Swing Low Color",   group = GRP_STYLE)

// ============================================================================
// B) CORE LOGIC
// ============================================================================

// -- Swing Detection --
swingHigh = ta.pivothigh(high, pivotLen, pivotLen)
swingLow  = ta.pivotlow(low,  pivotLen, pivotLen)

// -- Track Swing History --
var float sh1     = na      // Most recent Swing High
var float sh0     = na      // Previous Swing High
var int   sh1_idx = na
var int   sh0_idx = na

var float sl1     = na      // Most recent Swing Low
var float sl0     = na      // Previous Swing Low
var int   sl1_idx = na
var int   sl0_idx = na

var float slBeforeSH     = na   // Last SL before the most recent SH
var int   slBeforeSH_idx = na
var float shBeforeSL     = na   // Last SH before the most recent SL
var int   shBeforeSL_idx = na

// -- Group Tracking (strongest level in swing group) --
// BUY:  shGroupMax = highest swing high in the group before break -> entry level
// SELL: slGroupMin = lowest swing low in the group before break -> entry level
var float shGroupMax     = na
var int   shGroupMax_idx = na
var float slGroupMin     = na
var int   slGroupMin_idx = na

if not na(swingLow)
    // Accumulate sl1 into slGroupMin before it gets pushed to sl0
    if not na(sl1)
        if na(slGroupMin) or sl1 < slGroupMin
            slGroupMin     := sl1
            slGroupMin_idx := sl1_idx
    sl0     := sl1
    sl0_idx := sl1_idx
    sl1     := swingLow
    sl1_idx := bar_index - pivotLen

if not na(swingHigh)
    // Accumulate sh1 into shGroupMax before it gets pushed to sh0
    if not na(sh1)
        if na(shGroupMax) or sh1 > shGroupMax
            shGroupMax     := sh1
            shGroupMax_idx := sh1_idx
    slBeforeSH     := sl1
    slBeforeSH_idx := sl1_idx
    sh0     := sh1
    sh0_idx := sh1_idx
    sh1     := swingHigh
    sh1_idx := bar_index - pivotLen

if not na(swingLow)
    shBeforeSL     := sh1
    shBeforeSL_idx := sh1_idx

// -- HH / LL Detection --
bool isNewHH = not na(swingHigh) and not na(sh0) and sh1 > sh0
bool isNewLL = not na(swingLow)  and not na(sl0) and sl1 < sl0

// -- Break Strength Filter (optional, default OFF) --
bool rawBreakUp  = false
bool rawBreakDown = false

if isNewHH and not na(slBeforeSH)
    if breakMult <= 0
        rawBreakUp := true
    else
        float swR = sh0 - slBeforeSH
        float brD = sh1 - sh0
        if swR > 0 and brD >= swR * breakMult
            rawBreakUp := true

if isNewLL and not na(shBeforeSL)
    if breakMult <= 0
        rawBreakDown := true
    else
        float swR = shBeforeSL - sl0
        float brD = sl0 - sl1
        if swR > 0 and brD >= swR * breakMult
            rawBreakDown := true

// ============================================================================
// C) CONFIRMATION STATE MACHINE
// ============================================================================
// States:
//   0 = idle (no pending break)
//   1 = waiting for BUY confirmation
//  -1 = waiting for SELL confirmation
//
// BUY:  after HH break, wait for new swing HIGH > break point
//       Invalidate if price low touches entry level.
// SELL: after LL break, wait for new swing LOW < break point
//       Invalidate if price high touches entry level.

var int   pendingState   = 0    // 0=idle, 1=pendingBuy, -1=pendingSell
var float pendBreakPoint = na   // Break point (sh1 for buy, sl1 for sell)
var float pendEntry      = na   // Entry level (group extreme)
var float pendSL         = na   // Stop Loss level
var int   pendEntry_idx  = na
var int   pendSL_idx     = na
var int   pendBreak_idx  = na

// Confirmed break signals (for plotting and alerts)
bool confirmedBuy  = false
bool confirmedSell = false

// -- Step 1: Check confirmation FIRST (before new break overwrites) --
if pendingState == 1 and not na(swingHigh) and not na(pendBreakPoint)
    if swingHigh > pendBreakPoint
        confirmedBuy := true
        pendingState := 0

if pendingState == -1 and not na(swingLow) and not na(pendBreakPoint)
    if swingLow < pendBreakPoint
        confirmedSell := true
        pendingState  := 0

// -- Step 2: Check invalidation (price touched entry level) --
if pendingState == 1 and not na(pendEntry)
    if low <= pendEntry
        pendingState := 0

if pendingState == -1 and not na(pendEntry)
    if high >= pendEntry
        pendingState := 0

// -- Step 3: New raw break -> enter pending state --
if rawBreakUp
    pendingState   := 1
    pendBreakPoint := sh1
    // Entry = highest high in the swing group (if valid < sh1), else sh0
    if not na(shGroupMax) and shGroupMax < sh1
        pendEntry     := shGroupMax
        pendEntry_idx := shGroupMax_idx
    else
        pendEntry     := sh0
        pendEntry_idx := sh0_idx
    pendSL         := slBeforeSH
    pendSL_idx     := slBeforeSH_idx
    pendBreak_idx  := sh1_idx
    // Reset group for next cycle
    shGroupMax     := na
    shGroupMax_idx := na

if rawBreakDown
    pendingState   := -1
    pendBreakPoint := sl1
    // Entry = lowest low in the swing group (if valid > sl1), else sl0
    if not na(slGroupMin) and slGroupMin > sl1
        pendEntry     := slGroupMin
        pendEntry_idx := slGroupMin_idx
    else
        pendEntry     := sl0
        pendEntry_idx := sl0_idx
    pendSL         := shBeforeSL
    pendSL_idx     := shBeforeSL_idx
    pendBreak_idx  := sl1_idx
    // Reset group for next cycle
    slGroupMin     := na
    slGroupMin_idx := na

// ============================================================================
// D) PLOTTING / UI
// ============================================================================

// -- Swing Points --
plotshape(showSwings and not na(swingHigh), title = "Swing High",
     style = shape.triangledown, location = location.abovebar,
     color = colSwingHigh, offset = -pivotLen, size = size.tiny)

plotshape(showSwings and not na(swingLow), title = "Swing Low",
     style = shape.triangleup, location = location.belowbar,
     color = colSwingLow, offset = -pivotLen, size = size.tiny)

// -- Persistent Lines --
var line  activeEntryLine = na
var line  activeSLLine    = na
var label activeEntryLbl  = na
var label activeSLLbl     = na

f_terminateLines() =>
    if not na(activeEntryLine)
        line.set_x2(activeEntryLine, bar_index)
    if not na(activeSLLine)
        line.set_x2(activeSLLine, bar_index)
    if not na(activeEntryLbl)
        label.set_x(activeEntryLbl, bar_index)
    if not na(activeSLLbl)
        label.set_x(activeSLLbl, bar_index)

// -- Confirmed BUY Break --
if confirmedBuy
    if showBreakLine
        f_terminateLines()
        activeEntryLine := line.new(pendEntry_idx, pendEntry, bar_index, pendEntry,
             xloc = xloc.bar_index, color = colEntryBuy,
             style = line.style_dashed, width = 1)
        activeEntryLbl := label.new(bar_index, pendEntry, "Entry Buy",
             xloc = xloc.bar_index, yloc = yloc.price,
             style = label.style_none, textcolor = colEntryBuy, size = size.tiny)
        activeSLLine := line.new(pendSL_idx, pendSL, bar_index, pendSL,
             xloc = xloc.bar_index, color = colSL,
             style = line.style_dashed, width = 1)
        activeSLLbl := label.new(bar_index, pendSL, "SL",
             xloc = xloc.bar_index, yloc = yloc.price,
             style = label.style_none, textcolor = colSL, size = size.tiny)

    if showBreakLabel
        label.new(pendBreak_idx, pendBreakPoint, "▲ Break ✓",
             xloc = xloc.bar_index, yloc = yloc.price,
             style = label.style_label_down, color = colBreakUp,
             textcolor = color.white, size = size.tiny)

// -- Confirmed SELL Break --
if confirmedSell
    if showBreakLine
        f_terminateLines()
        activeEntryLine := line.new(pendEntry_idx, pendEntry, bar_index, pendEntry,
             xloc = xloc.bar_index, color = colEntrySell,
             style = line.style_dashed, width = 1)
        activeEntryLbl := label.new(bar_index, pendEntry, "Entry Sell",
             xloc = xloc.bar_index, yloc = yloc.price,
             style = label.style_none, textcolor = colEntrySell, size = size.tiny)
        activeSLLine := line.new(pendSL_idx, pendSL, bar_index, pendSL,
             xloc = xloc.bar_index, color = colSL,
             style = line.style_dashed, width = 1)
        activeSLLbl := label.new(bar_index, pendSL, "SL",
             xloc = xloc.bar_index, yloc = yloc.price,
             style = label.style_none, textcolor = colSL, size = size.tiny)

    if showBreakLabel
        label.new(pendBreak_idx, pendBreakPoint, "▼ Break ✓",
             xloc = xloc.bar_index, yloc = yloc.price,
             style = label.style_label_up, color = colBreakDown,
             textcolor = color.white, size = size.tiny)

// -- Extend active lines to the right every bar --
if not na(activeEntryLine)
    line.set_x2(activeEntryLine, bar_index)
if not na(activeSLLine)
    line.set_x2(activeSLLine, bar_index)
if not na(activeEntryLbl)
    label.set_x(activeEntryLbl, bar_index)
if not na(activeSLLbl)
    label.set_x(activeSLLbl, bar_index)

// ============================================================================
// E) ALERTS
// ============================================================================
alertcondition(confirmedBuy,                    title = "Confirmed Break Buy",  message = "PA Break: Confirmed BUY on {{ticker}} @ {{close}}")
alertcondition(confirmedSell,                   title = "Confirmed Break Sell", message = "PA Break: Confirmed SELL on {{ticker}} @ {{close}}")
alertcondition(confirmedBuy or confirmedSell,   title = "Any Confirmed Break",  message = "PA Break: Confirmed breakout on {{ticker}} @ {{close}}")
